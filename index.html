<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ORBIS — Live Satellite Tracker</title>
<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Barlow:wght@300;400;600;700&family=Barlow+Condensed:wght@700;900&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/satellite.js/4.1.3/satellite.min.js"></script>
<style>
  :root {
    --bg: #020b14;
    --surface: #071828;
    --panel: #0a1f30;
    --accent: #00f0ff;
    --accent2: #ff6b35;
    --accent3: #7fff6e;
    --text: #c8e0f0;
    --muted: #4a7a99;
    --border: #0d3050;
    --glow: 0 0 20px rgba(0,240,255,0.3);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Barlow', sans-serif;
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* Starfield */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image:
      radial-gradient(1px 1px at 10% 15%, rgba(255,255,255,0.6) 0%, transparent 100%),
      radial-gradient(1px 1px at 25% 40%, rgba(255,255,255,0.4) 0%, transparent 100%),
      radial-gradient(1px 1px at 40% 10%, rgba(255,255,255,0.7) 0%, transparent 100%),
      radial-gradient(1px 1px at 60% 80%, rgba(255,255,255,0.5) 0%, transparent 100%),
      radial-gradient(1px 1px at 75% 25%, rgba(255,255,255,0.6) 0%, transparent 100%),
      radial-gradient(1px 1px at 85% 60%, rgba(255,255,255,0.4) 0%, transparent 100%),
      radial-gradient(1px 1px at 92% 10%, rgba(255,255,255,0.7) 0%, transparent 100%),
      radial-gradient(1px 1px at 5% 70%, rgba(255,255,255,0.5) 0%, transparent 100%),
      radial-gradient(1px 1px at 50% 55%, rgba(255,255,255,0.3) 0%, transparent 100%),
      radial-gradient(2px 2px at 33% 88%, rgba(0,240,255,0.4) 0%, transparent 100%),
      radial-gradient(2px 2px at 68% 44%, rgba(0,240,255,0.3) 0%, transparent 100%),
      radial-gradient(1px 1px at 15% 55%, rgba(255,255,255,0.5) 0%, transparent 100%),
      radial-gradient(1px 1px at 88% 78%, rgba(255,255,255,0.4) 0%, transparent 100%);
    pointer-events: none;
    z-index: 0;
  }

  header {
    position: relative;
    z-index: 10;
    padding: 24px 40px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    border-bottom: 1px solid var(--border);
    background: linear-gradient(180deg, rgba(2,11,20,0.95) 0%, rgba(2,11,20,0.7) 100%);
    backdrop-filter: blur(10px);
  }

  .logo {
    display: flex;
    align-items: baseline;
    gap: 12px;
  }

  .logo-text {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 2.4rem;
    font-weight: 900;
    letter-spacing: 0.15em;
    color: var(--accent);
    text-shadow: var(--glow);
  }

  .logo-sub {
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.65rem;
    color: var(--muted);
    letter-spacing: 0.2em;
    text-transform: uppercase;
  }

  .header-status {
    display: flex;
    align-items: center;
    gap: 8px;
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.75rem;
    color: var(--accent3);
  }

  .pulse-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--accent3);
    animation: pulse 1.5s infinite;
    box-shadow: 0 0 8px var(--accent3);
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.4; transform: scale(0.7); }
  }

  #utc-clock {
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.85rem;
    color: var(--accent);
    letter-spacing: 0.1em;
  }

  .main-grid {
    position: relative;
    z-index: 5;
    display: grid;
    grid-template-columns: 340px 1fr;
    grid-template-rows: auto 1fr;
    gap: 0;
    height: calc(100vh - 73px);
  }

  /* LEFT PANEL */
  .left-panel {
    grid-row: 1 / 3;
    background: var(--surface);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .panel-header {
    padding: 16px 20px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .panel-title {
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.7rem;
    letter-spacing: 0.2em;
    color: var(--muted);
    text-transform: uppercase;
  }

  .sat-count {
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.7rem;
    color: var(--accent);
    background: rgba(0,240,255,0.08);
    padding: 3px 10px;
    border-radius: 2px;
    border: 1px solid rgba(0,240,255,0.2);
  }

  /* Category Tabs */
  .category-tabs {
    display: flex;
    border-bottom: 1px solid var(--border);
    overflow-x: auto;
    scrollbar-width: none;
  }
  .category-tabs::-webkit-scrollbar { display: none; }

  .cat-tab {
    flex-shrink: 0;
    padding: 10px 14px;
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.62rem;
    color: var(--muted);
    cursor: pointer;
    border-bottom: 2px solid transparent;
    transition: all 0.2s;
    letter-spacing: 0.05em;
    white-space: nowrap;
    background: none;
    border-top: none;
    border-left: none;
    border-right: none;
  }

  .cat-tab:hover { color: var(--text); }
  .cat-tab.active { color: var(--accent); border-bottom-color: var(--accent); }

  /* Satellite list */
  .sat-list {
    flex: 1;
    overflow-y: auto;
    scrollbar-width: thin;
    scrollbar-color: var(--border) transparent;
  }

  .sat-list::-webkit-scrollbar { width: 4px; }
  .sat-list::-webkit-scrollbar-track { background: transparent; }
  .sat-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

  .sat-item {
    padding: 12px 20px;
    border-bottom: 1px solid rgba(13,48,80,0.5);
    cursor: pointer;
    transition: background 0.15s;
    display: grid;
    grid-template-columns: 1fr auto;
    gap: 4px;
    align-items: center;
  }

  .sat-item:hover { background: rgba(0,240,255,0.04); }
  .sat-item.active { background: rgba(0,240,255,0.08); border-left: 2px solid var(--accent); }

  .sat-name {
    font-size: 0.82rem;
    font-weight: 600;
    color: var(--text);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .sat-id {
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.6rem;
    color: var(--muted);
  }

  .sat-alt {
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.65rem;
    color: var(--accent3);
    text-align: right;
  }

  .sat-type-badge {
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.55rem;
    padding: 1px 6px;
    border-radius: 2px;
    text-align: right;
  }

  .loading-msg {
    padding: 40px 20px;
    text-align: center;
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.75rem;
    color: var(--muted);
  }

  .loading-spinner {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 2px solid var(--border);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    margin-bottom: 12px;
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  /* MAP AREA */
  .map-area {
    position: relative;
    background: var(--bg);
    overflow: hidden;
  }

  #world-map {
    width: 100%;
    height: 100%;
  }

  /* INFO PANEL (bottom right) */
  .info-panel {
    background: var(--panel);
    border-top: 1px solid var(--border);
    padding: 20px 28px;
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 20px;
  }

  .info-block { }

  .info-label {
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.6rem;
    color: var(--muted);
    letter-spacing: 0.15em;
    text-transform: uppercase;
    margin-bottom: 6px;
  }

  .info-value {
    font-family: 'Share Tech Mono', monospace;
    font-size: 1.1rem;
    color: var(--accent);
    font-weight: 400;
  }

  .info-value.orange { color: var(--accent2); }
  .info-value.green { color: var(--accent3); }

  .info-unit {
    font-size: 0.65rem;
    color: var(--muted);
    margin-left: 4px;
  }

  /* Selected satellite name overlay */
  .selected-overlay {
    position: absolute;
    top: 20px;
    right: 20px;
    background: rgba(7,24,40,0.92);
    border: 1px solid var(--accent);
    border-radius: 4px;
    padding: 14px 18px;
    backdrop-filter: blur(8px);
    box-shadow: var(--glow);
    display: none;
    min-width: 200px;
  }

  .selected-overlay.visible { display: block; }

  .sel-name {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 1.2rem;
    font-weight: 700;
    color: var(--accent);
    letter-spacing: 0.05em;
    margin-bottom: 4px;
  }

  .sel-norad {
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.65rem;
    color: var(--muted);
  }

  /* Map grid lines */
  .grid-line { stroke: rgba(13,48,80,0.4); stroke-width: 0.5; fill: none; }
  .coast { stroke: rgba(0,240,255,0.15); stroke-width: 0.8; fill: rgba(0,240,255,0.02); }
  .sat-dot { cursor: pointer; transition: r 0.1s; }
  .sat-dot:hover { r: 5; }
  .sat-trail { fill: none; stroke-dasharray: 4 3; opacity: 0.4; }

  .iss-dot { fill: var(--accent2); filter: drop-shadow(0 0 6px var(--accent2)); }
  .normal-dot { fill: var(--accent); filter: drop-shadow(0 0 3px var(--accent)); }
  .selected-dot { fill: #fff; filter: drop-shadow(0 0 8px #fff); r: 6; }

  .error-msg {
    padding: 20px;
    text-align: center;
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.7rem;
    color: var(--accent2);
  }
</style>
</head>
<body>

<header>
  <div class="logo">
    <span class="logo-text">ORBIS</span>
    <span class="logo-sub">Live Satellite Tracking System</span>
  </div>
  <div style="display:flex;gap:24px;align-items:center;">
    <div class="header-status">
      <div class="pulse-dot"></div>
      <span>LIVE TRACKING</span>
    </div>
    <div id="utc-clock">UTC 00:00:00</div>
  </div>
</header>

<div class="main-grid">
  <!-- LEFT PANEL -->
  <div class="left-panel">
    <div class="panel-header">
      <span class="panel-title">Tracked Objects</span>
      <span class="sat-count" id="sat-count">— OBJ</span>
    </div>
    <div class="category-tabs" id="cat-tabs">
      <button class="cat-tab active" data-cat="stations">STATIONS</button>
      <button class="cat-tab" data-cat="active">ACTIVE SATS</button>
      <button class="cat-tab" data-cat="starlink">STARLINK</button>
      <button class="cat-tab" data-cat="weather">WEATHER</button>
      <button class="cat-tab" data-cat="debris">DEBRIS</button>
    </div>
    <div class="sat-list" id="sat-list">
      <div class="loading-msg">
        <div class="loading-spinner"></div><br>
        Fetching TLE data from Celestrak...
      </div>
    </div>
  </div>

  <!-- MAP -->
  <div class="map-area" id="map-area">
    <svg id="world-map" viewBox="0 0 1000 500" preserveAspectRatio="xMidYMid meet"></svg>
    <div class="selected-overlay" id="selected-overlay">
      <div class="sel-name" id="sel-name">—</div>
      <div class="sel-norad" id="sel-norad">NORAD ID: —</div>
    </div>
  </div>

  <!-- INFO PANEL -->
  <div class="info-panel" id="info-panel">
    <div class="info-block">
      <div class="info-label">Latitude</div>
      <div class="info-value" id="info-lat">—</div>
    </div>
    <div class="info-block">
      <div class="info-label">Longitude</div>
      <div class="info-value" id="info-lon">—</div>
    </div>
    <div class="info-block">
      <div class="info-label">Altitude</div>
      <div class="info-value green" id="info-alt">—<span class="info-unit">km</span></div>
    </div>
    <div class="info-block">
      <div class="info-label">Velocity</div>
      <div class="info-value orange" id="info-vel">—<span class="info-unit">km/s</span></div>
    </div>
  </div>
</div>

<script>
// ─── UTC Clock ────────────────────────────────────────────────────────────────
function updateClock() {
  const now = new Date();
  const h = String(now.getUTCHours()).padStart(2,'0');
  const m = String(now.getUTCMinutes()).padStart(2,'0');
  const s = String(now.getUTCSeconds()).padStart(2,'0');
  document.getElementById('utc-clock').textContent = `UTC ${h}:${m}:${s}`;
}
setInterval(updateClock, 1000);
updateClock();

// ─── World Map SVG (Simplified coastlines via path approximation) ─────────────
const SVG_NS = 'http://www.w3.org/2000/svg';
const svg = document.getElementById('world-map');
const W = 1000, H = 500;

// Draw grid
function drawGrid() {
  for (let lon = -180; lon <= 180; lon += 30) {
    const x = lonToX(lon);
    const line = document.createElementNS(SVG_NS, 'line');
    line.setAttribute('x1', x); line.setAttribute('y1', 0);
    line.setAttribute('x2', x); line.setAttribute('y2', H);
    line.setAttribute('class', 'grid-line');
    svg.appendChild(line);
  }
  for (let lat = -90; lat <= 90; lat += 30) {
    const y = latToY(lat);
    const line = document.createElementNS(SVG_NS, 'line');
    line.setAttribute('x1', 0); line.setAttribute('y1', y);
    line.setAttribute('x2', W); line.setAttribute('y2', y);
    line.setAttribute('class', 'grid-line');
    svg.appendChild(line);
  }
  // Equator highlight
  const eq = document.createElementNS(SVG_NS, 'line');
  eq.setAttribute('x1', 0); eq.setAttribute('y1', H/2);
  eq.setAttribute('x2', W); eq.setAttribute('y2', H/2);
  eq.setAttribute('stroke', 'rgba(0,240,255,0.12)');
  eq.setAttribute('stroke-width', '1');
  svg.appendChild(eq);
}

function lonToX(lon) { return (lon + 180) / 360 * W; }
function latToY(lat) { return (90 - lat) / 180 * H; }

drawGrid();

// Simple world map outline using Natural Earth–style approximate paths
// Using a fetch from a public GeoJSON source
async function drawWorldMap() {
  try {
    // Use a simple low-res world SVG path via Unpkg/CDN approach
    // We'll draw simplified continent shapes manually
    drawSimpleContinents();
  } catch(e) {
    drawSimpleContinents();
  }
}

function drawSimpleContinents() {
  // Simplified continent polygons as lon/lat arrays
  const continents = [
    // North America
    [['-168','71'],['-140','71'],['-130','54'],['-125','49'],['-124','48'],['-117','32'],['-97','26'],['-87','16'],['-83','10'],['-77','8'],['-75','4'],['-55','2'],['-52','4'],['-50','0'],['-50','5'],['-60','8'],['-73','12'],['-82','10'],['-83','15'],['-90','16'],['-90','20'],['-87','16'],
     ['-97','26'],['-117','32'],['-124','48'],['-125','49'],['-95','49'],['-95','50'],['-85','45'],['-77','44'],['-70','46'],['-67','47'],['-61','46'],['-60','50'],['-65','60'],['-64','63'],['-70','63'],['-75','63'],['-80','63'],['-85','63'],['-90','63'],['-95','63'],['-100','63'],['-105','63'],['-110','63'],['-120','63'],['-130','60'],['-135','60'],['-140','60'],['-150','61'],['-155','59'],['-162','60'],['-165','63'],['-168','66'],['-168','71']],
    // Greenland
    [['-73','83'],['-20','84'],['-17','77'],['-25','70'],['-45','60'],['-54','64'],['-60','68'],['-65','72'],['-70','76'],['-73','83']],
    // South America
    [['-82','9'],['-77','8'],['-75','4'],['-55','2'],['-52','4'],['-50','0'],['-50','-10'],['-38','-15'],['-35','-9'],['-35','-5'],['-38','0'],['-48','-28'],['-52','-33'],['-58','-38'],['-65','-55'],['-70','-55'],['-75','-50'],['-75','-42'],['-70','-35'],['-73','-40'],['-75','-30'],['-70','-17'],['-75','-10'],['-78','-2'],['-78','2'],['-82','9']],
    // Europe
    [['0','51'],['2','52'],['5','53'],['10','55'],['12','56'],['18','57'],['25','60'],['28','65'],['30','70'],['28','72'],['20','70'],['15','69'],['10','63'],['5','58'],['8','55'],['10','55'],['15','54'],['20','54'],['22','50'],['28','46'],['30','45'],['35','42'],['28','38'],['26','38'],['22','38'],['20','37'],['15','38'],['12','38'],['10','40'],['8','44'],['2','44'],['0','44'],['-2','44'],['-5','44'],['-8','44'],['-9','39'],['-8','37'],['-5','36'],['-2','36'],['5','37'],['8','37'],['0','51']],
    // Africa
    [['10','37'],['15','37'],['25','37'],['35','37'],['38','37'],['42','37'],['43','10'],['51','11'],['51','24'],['38','22'],['37','12'],['43','11'],['42','2'],['40','-5'],['35','-10'],['35','-24'],['29','-30'],['18','-35'],['17','-29'],['12','-18'],['-2','-5'],['8','4'],['2','5'],['0','5'],['-10','5'],['-16','12'],['-17','14'],['-17','20'],['-13','20'],['0','20'],['5','15'],['10','10'],['8','10'],['10','37']],
    // Asia
    [['28','72'],['38','72'],['50','70'],['60','70'],['70','73'],['80','77'],['90','77'],['100','75'],['120','72'],['140','73'],['160','72'],['180','68'],['180','60'],['170','60'],['160','60'],['150','60'],['145','55'],['140','50'],['135','48'],['130','42'],['126','38'],['122','32'],['120','25'],['110','20'],['105','10'],['100','3'],['103','1'],['104','-1'],['108','3'],['110','1'],['116','4'],['120','10'],['122','18'],['120','25'],['110','20'],['105','20'],['100','22'],['93','27'],['90','23'],['88','23'],['85','28'],['80','30'],['73','24'],['67','23'],['60','22'],['55','22'],['45','12'],['43','11'],['43','10'],['51','11'],['55','23'],['60','22'],['60','28'],['65','35'],['60','38'],['55','41'],['50','40'],['45','42'],['40','42'],['35','42'],['30','45'],['28','46'],['35','47'],['40','52'],['45','50'],['50','55'],['55','60'],['60','65'],['65','67'],['70','68'],['80','68'],['90','68'],['100','68'],['120','68'],['140','70'],['160','68'],['180','68'],['180','60'],['160','60'],['145','55'],['135','48'],['130','42'],['140','50'],['150','55'],['160','60'],['170','60'],['180','55'],['180','45'],['170','45'],['160','38'],['150','37'],['142','40'],['135','45'],['133','43'],['130','42'],['126','38'],['122','32'],['120','25'],['110','20'],['103','1'],['100','3'],['95','5'],['95','10'],['93','20'],['90','23'],['88','28'],['85','28'],['80','30'],['78','28'],['73','28'],['70','23'],['66','25'],['62','23'],['58','22'],['55','23'],['53','30'],['50','30'],['45','30'],['40','38'],['35','37'],['38','37'],['42','37'],['42','40'],['38','42'],['35','42'],['30','45'],['28','46'],['22','50'],['20','54'],['25','60'],['28','65'],['30','70'],['28','72']],
    // Australia
    [['114','-24'],['118','-20'],['122','-18'],['130','-12'],['136','-12'],['140','-16'],['148','-18'],['154','-28'],['152','-32'],['150','-36'],['145','-38'],['140','-38'],['136','-35'],['130','-34'],['123','-34'],['118','-32'],['114','-29'],['114','-24']]
  ];

  continents.forEach(coords => {
    const path = document.createElementNS(SVG_NS, 'polygon');
    const points = coords.map(([lon,lat]) => `${lonToX(parseFloat(lon))},${latToY(parseFloat(lat))}`).join(' ');
    path.setAttribute('points', points);
    path.setAttribute('class', 'coast');
    svg.appendChild(path);
  });
}

drawWorldMap();

// ─── Satellite Group Definitions ──────────────────────────────────────────────
const CATEGORIES = {
  stations: { url: 'https://celestrak.org/SOCRATES/query.php?CODE=ISS&FORMAT=TLE', name: 'Space Stations', celestrakGroup: 'stations' },
  active:   { celestrakGroup: 'active', name: 'Active Satellites' },
  starlink: { celestrakGroup: 'starlink', name: 'Starlink' },
  weather:  { celestrakGroup: 'weather', name: 'Weather Satellites' },
  debris:   { celestrakGroup: 'debris', name: 'Debris (1999-025)' },
};

const CELESTRAK_BASE = 'https://celestrak.org/SOCRATES/query.php';
const PROXY = 'https://api.allorigins.win/get?url=';
const CELESTRAK_TLE = 'https://celestrak.org/SOCRATES/query.php';

// Map satellite category to Celestrak URL
function getCelestrakUrl(group) {
  const map = {
    stations: 'https://celestrak.org/SOCRATES/query.php?CODE=ISS&FORMAT=TLE',
    active:   'https://celestrak.org/pub/TLE/group/active.txt',
    starlink: 'https://celestrak.org/pub/TLE/group/starlink.txt',
    weather:  'https://celestrak.org/pub/TLE/group/weather.txt',
    debris:   'https://celestrak.org/pub/TLE/group/1999-025.txt',
  };
  return map[group];
}

// ─── TLE Parsing ──────────────────────────────────────────────────────────────
function parseTLE(text) {
  const lines = text.trim().split('\n').map(l => l.trim()).filter(l => l.length > 0);
  const sats = [];
  for (let i = 0; i < lines.length - 2; i++) {
    if (!lines[i+1].startsWith('1 ') && !lines[i+1].startsWith('1\t')) continue;
    if (!lines[i+2].startsWith('2 ') && !lines[i+2].startsWith('2\t')) continue;
    sats.push({ name: lines[i], tle1: lines[i+1], tle2: lines[i+2] });
    i += 2;
  }
  return sats;
}

// ─── Satellite State ──────────────────────────────────────────────────────────
let allSats = [];
let selectedIdx = null;
let animFrame = null;
let satDots = {};
let currentCategory = 'stations';
let lastPositions = {};

// ─── Fetch TLE data ───────────────────────────────────────────────────────────
async function fetchTLE(category) {
  const listEl = document.getElementById('sat-list');
  listEl.innerHTML = `<div class="loading-msg"><div class="loading-spinner"></div><br>Loading TLE data...</div>`;

  let text = null;

  // 1. Try local Flask proxy (works when running via server.py)
  try {
    const resp = await fetch(`/tle/${category}`);
    if (resp.ok) text = await resp.text();
  } catch(e) {}

  // 2. Try direct Celestrak fetch
  if (!text) {
    try {
      const url = getCelestrakUrl(category);
      const resp = await fetch(url);
      if (resp.ok) text = await resp.text();
    } catch(e) {}
  }

  // 3. Try allorigins CORS proxy
  if (!text) {
    try {
      const url = getCelestrakUrl(category);
      const proxy = `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`;
      const resp = await fetch(proxy);
      if (resp.ok) {
        const data = await resp.json();
        text = data.contents;
      }
    } catch(e) {}
  }

  // 4. Fallback to hardcoded TLEs
  if (!text || text.length < 50) {
    text = getFallbackTLE(category);
  }

  if (!text) {
    listEl.innerHTML = `<div class="error-msg">⚠ Failed to fetch TLE data.<br>Check network / CORS settings.</div>`;
    return;
  }

  allSats = parseTLE(text);
  // Limit for performance
  if (allSats.length > 200) allSats = allSats.slice(0, 200);

  document.getElementById('sat-count').textContent = `${allSats.length} OBJ`;
  renderSatList();
  clearSVGSats();
  if (animFrame) cancelAnimationFrame(animFrame);
  animateSats();
}

function getFallbackTLE(category) {
  // Hardcoded fallback TLEs for common satellites
  const fallbacks = {
    stations: `ISS (ZARYA)
1 25544U 98067A   24001.50000000  .00016717  00000-0  10270-3 0  9999
2 25544  51.6416 247.4627 0006703 130.5360 325.0288 15.50244421419503
TIANGONG (CSS)
1 48274U 21035A   24001.50000000  .00007000  00000-0  79400-4 0  9999
2 48274  41.4708 256.4141 0005500 290.0000 70.0000 15.61000000 99999`,
    active: `ISS (ZARYA)
1 25544U 98067A   24001.50000000  .00016717  00000-0  10270-3 0  9999
2 25544  51.6416 247.4627 0006703 130.5360 325.0288 15.50244421419503
TERRA
1 25994U 99068A   24001.50000000  .00000050  00000-0  15130-4 0  9999
2 25994  98.1995 221.5000 0001300 111.0000 249.1000 14.57110577999999
NOAA 15
1 25338U 98030A   24001.50000000  .00000050  00000-0  00000+0 0  9999
2 25338  98.7000 100.0000 0011000 100.0000 260.0000 14.26000000999999
AQUA
1 27424U 02022A   24001.50000000  .00000050  00000-0  15000-4 0  9999
2 27424  98.2000 222.0000 0001100 110.0000 250.0000 14.57000000999999
AURA
1 28376U 04026A   24001.50000000  .00000050  00000-0  15000-4 0  9999
2 28376  98.2200 221.0000 0001000 120.0000 240.0000 14.57000000999999`,
    starlink: `STARLINK-1007
1 44713U 19074A   24001.50000000  .00002000  00000-0  10000-3 0  9999
2 44713  53.0000  20.0000 0001000   0.0000  20.0000 15.06000000999999
STARLINK-1008
1 44714U 19074B   24001.50000000  .00002000  00000-0  10000-3 0  9999
2 44714  53.0000  25.0000 0001000   0.0000  25.0000 15.06000000999999
STARLINK-1009
1 44715U 19074C   24001.50000000  .00002000  00000-0  10000-3 0  9999
2 44715  53.0000  30.0000 0001000   0.0000  30.0000 15.06000000999999`,
    weather: `NOAA 18
1 28654U 05018A   24001.50000000  .00000050  00000-0  49000-4 0  9999
2 28654  98.8000 200.0000 0014000  90.0000 270.0000 14.09000000999999
GOES 16
1 41866U 16071A   24001.50000000 -.00000299  00000-0  00000+0 0  9999
2 41866   0.0500 267.0000 0000741  70.0000 290.0000  1.00270000999999
METEOSAT-9
1 28912U 06006A   24001.50000000 -.00000299  00000-0  00000+0 0  9999
2 28912   0.0500  62.0000 0001500  60.0000 300.0000  1.00270000999999`,
    debris: `FENGYUN 1C DEB
1 29228U 99025CVA  24001.50000000  .00000500  00000-0  70000-4 0  9999
2 29228  98.4000 100.0000 0020000  90.0000 270.0000 14.10000000999999
COSMOS 2251 DEB
1 33739U 93036SXA  24001.50000000  .00000500  00000-0  80000-4 0  9999
2 33739  74.0000 200.0000 0050000  80.0000 280.0000 14.40000000999999`
  };
  return fallbacks[category] || fallbacks['active'];
}

// ─── Render Satellite List ────────────────────────────────────────────────────
function renderSatList() {
  const listEl = document.getElementById('sat-list');
  listEl.innerHTML = '';
  allSats.forEach((sat, i) => {
    const div = document.createElement('div');
    div.className = 'sat-item' + (i === selectedIdx ? ' active' : '');
    div.innerHTML = `
      <div>
        <div class="sat-name">${sat.name}</div>
        <div class="sat-id">NORAD ${sat.tle2.split(' ')[1].replace('U','')}</div>
      </div>
      <div>
        <div class="sat-alt" id="list-alt-${i}">— km</div>
      </div>`;
    div.onclick = () => selectSat(i);
    listEl.appendChild(div);
  });
}

function selectSat(i) {
  selectedIdx = i;
  document.querySelectorAll('.sat-item').forEach((el, idx) => {
    el.classList.toggle('active', idx === i);
  });
  const sat = allSats[i];
  document.getElementById('sel-name').textContent = sat.name;
  document.getElementById('sel-norad').textContent = `NORAD ${sat.tle2.split(' ')[1]}`;
  document.getElementById('selected-overlay').classList.add('visible');
  // Scroll into view
  document.querySelectorAll('.sat-item')[i]?.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
}

// ─── Clear SVG sat layer ──────────────────────────────────────────────────────
function clearSVGSats() {
  document.querySelectorAll('.sat-layer').forEach(e => e.remove());
  satDots = {};
}

// ─── Propagate and Animate ───────────────────────────────────────────────────
function animateSats() {
  const now = new Date();

  // Create/update dots
  allSats.forEach((sat, i) => {
    try {
      const satrec = satellite.twoline2satrec(sat.tle1, sat.tle2);
      const posVel = satellite.propagate(satrec, now);
      if (!posVel.position) return;

      const gmst = satellite.gstime(now);
      const geo = satellite.eciToGeodetic(posVel.position, gmst);
      const lat = satellite.degreesLat(geo.latitude);
      const lon = satellite.degreesLong(geo.longitude);
      const alt = geo.height; // km
      const vel = posVel.velocity;
      const speed = vel ? Math.sqrt(vel.x**2 + vel.y**2 + vel.z**2) : 0;

      const x = lonToX(lon);
      const y = latToY(lat);

      // Update list altitude
      const altEl = document.getElementById(`list-alt-${i}`);
      if (altEl) altEl.textContent = `${Math.round(alt)} km`;

      // Update or create SVG dot
      if (!satDots[i]) {
        const circle = document.createElementNS(SVG_NS, 'circle');
        circle.setAttribute('class', `sat-layer sat-dot ${sat.name.includes('ISS') || sat.name.includes('TIANGONG') ? 'iss-dot' : 'normal-dot'}`);
        circle.setAttribute('r', '3');
        circle.setAttribute('title', sat.name);
        circle.onclick = () => selectSat(i);
        svg.appendChild(circle);
        satDots[i] = circle;
      }

      const dot = satDots[i];
      dot.setAttribute('cx', x);
      dot.setAttribute('cy', y);

      if (i === selectedIdx) {
        dot.setAttribute('class', `sat-layer sat-dot selected-dot`);
        dot.setAttribute('r', '5');
        // Update info panel
        document.getElementById('info-lat').textContent = lat.toFixed(4) + '°';
        document.getElementById('info-lon').textContent = lon.toFixed(4) + '°';
        document.getElementById('info-alt').innerHTML = Math.round(alt) + '<span class="info-unit">km</span>';
        document.getElementById('info-vel').innerHTML = speed.toFixed(2) + '<span class="info-unit">km/s</span>';
      } else {
        const isStation = sat.name.includes('ISS') || sat.name.includes('TIANGONG');
        dot.setAttribute('class', `sat-layer sat-dot ${isStation ? 'iss-dot' : 'normal-dot'}`);
        dot.setAttribute('r', isStation ? '5' : '2.5');
      }
    } catch(e) {
      // skip bad TLE
    }
  });

  animFrame = requestAnimationFrame(animateSats);
}

// ─── Category Tabs ───────────────────────────────────────────────────────────
document.querySelectorAll('.cat-tab').forEach(tab => {
  tab.onclick = () => {
    document.querySelectorAll('.cat-tab').forEach(t => t.classList.remove('active'));
    tab.classList.add('active');
    currentCategory = tab.dataset.cat;
    selectedIdx = null;
    document.getElementById('selected-overlay').classList.remove('visible');
    document.getElementById('info-lat').textContent = '—';
    document.getElementById('info-lon').textContent = '—';
    document.getElementById('info-alt').innerHTML = '—<span class="info-unit">km</span>';
    document.getElementById('info-vel').innerHTML = '—<span class="info-unit">km/s</span>';
    fetchTLE(currentCategory);
  };
});

// ─── Boot ─────────────────────────────────────────────────────────────────────
fetchTLE('stations');
</script>
</body>
</html>
